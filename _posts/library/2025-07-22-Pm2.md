---
layout: post
title: LIBRARY - PM2 클러스터링
category: LIBRARY
---

# EC2에서 PM2 클러스터링 아키텍처 정리

PM2를 EC2에서 사용할 때 내가 헷갈렸던 부분들 정리.

---

## ✅ PM2가 하는 일

* 기본적으로 Node.js 앱을 여러 개의 프로세스로 띄워서 **멀티코어를 활용**하는 구조
* `pm2 start app.js -i max` 이런 식으로 쓰면 EC2의 코어 수만큼 프로세스를 띄워줌

---

## ❓ "서버가 늘어난다"는 건?

* 서버(서버 인스턴스)가 늘어나는 게 아님
* **Node.js 앱 프로세스가 여러 개로 늘어난다**는 뜻
* 예를 들어 EC2 안에서 app.js가 4개 떠 있는 것임 (포트를 내부적으로 포크 방식으로 처리함)

---

## ❓ PM2가 트래픽을 분산하는 방식은?

* **클러스터 모드**에서는 Node.js의 `cluster` 모듈을 활용해서
  요청(request)을 **라운드로빈 방식**으로 각 프로세스에 분배함

---

## ✅ 클러스터링이 효과적인 경우

* **CPU 부하가 클 때**
* 예: 암호화, 대량 계산, 이미지 처리 등

---

## ❌ 클러스터링이 별 효과 없는 경우

* **메모리가 부족한 상황**
* 각 프로세스가 메모리를 따로 사용함 (예: 하나당 200MB, 4개면 800MB)
* EC2 메모리가 부족하면 → 프로세스 죽거나 전체 서버가 불안정해짐

---

## 💡 클러스터링 + 메모리 병목일 때 대응 방법

1. `--max-old-space-size` 옵션으로 Node 메모리 제한
2. 클러스터 수 줄이기: `pm2 start app.js -i 2`
3. 캐시/세션을 외부 저장소(Redis 등)로 분리해서 메모리 사용 줄이기
4. 코드 구조 개선 (GC 유발 줄이기, 스트리밍 사용 등)

---

## 예시 시나리오 (문제 발생 케이스)

```
EC2 t2.micro (1vCPU, 1GB RAM)
PM2 클러스터 4개 사용

- CPU 사용률: 30%
- 메모리 사용량: 1.2GB → OOM Kill 발생 → 서버 죽음
```

---

## 결론

> "PM2 클러스터링 = CPU 최적화용"이지, 메모리 부족 상황에서는 **오히려 독**될 수 있음

EC2의 병목 리소스가 CPU면 PM2로 효과 있음,
메모리면 클러스터 수 줄이거나 스펙 업그레이드 고려해야 함.
