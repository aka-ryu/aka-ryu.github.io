---
layout: post
title: INFRA - ALB + Cloudflare로 EC2 서버 IP 보호하기
categories: INFRA
---

## 개요

멀티테넌트 환경에서 여러 협력업체가 우리 서버를 바라보고 있는 상황에서, `whois`로 검색하면 EC2 IP가 그대로 노출되는 문제가 있었다.  
보안상 큰 문제는 아니지만, 실제 서버 IP가 외부에 노출되는 것을 방지하기 위해 ALB와 Cloudflare를 조합한 구조로 개선하였다.

## 기존 구조의 문제점

```
협력업체 도메인
  ↓
내 도메인 (A 레코드)
  ↓
EC2 Public IP (whois로 노출)
```

기존 구조의 문제:
- EC2 IP가 DNS 레코드에 그대로 노출됨
- 멀티테넌트 환경에서 보안상 취약점 존재
- 서버 이전 시 모든 협력업체에 IP 변경 요청 필요

## 해결 방법: ALB + Cloudflare

### 최종 아키텍처

```
협력업체 도메인
  ↓ Cloudflare Proxy
Cloudflare Edge
  ↓ HTTPS
ALB (DNS 전용, 직접 접근 차단)
  ↓ HTTP (Private Network)
EC2 (Private IP)
```

### 선택 이유

**Cloudflare만으로는 부족한 이유**
- Error 1014 (CNAME Cross-User Banned) 발생
- 다른 계정의 도메인이 우리 프록시 도메인을 CNAME으로 가리킬 수 없음

**ALB를 중간에 추가하는 장점**
- 협력업체는 자유롭게 설정 가능
- EC2를 Private으로 완전히 격리
- 다층 보안 구조 구성 가능

## 구축 과정

### 1. Target Group 생성

```
타입: Instances
프로토콜: HTTP
포트: 3000
Health Check 경로: /api/health
```

**주의:** Health Check 경로가 중요함. `/`로 했다가 307 리다이렉트 때문에 unhealthy 떴음. `/api/health` 같은 200 응답하는 엔드포인트로 설정해야 함.

### 2. ALB 생성

```
스키마: Internet-facing
가용 영역: 최소 2개
보안 그룹: 80, 443 포트 오픈
```

**삽질 포인트:** EC2 가용 영역을 ALB 가용 영역에 반드시 포함시켜야 함. 안 그러면 타임아웃 지옥.

### 3. EC2 보안 그룹 수정

```
기존: 3000번 포트 전체 오픈
변경: 3000번 포트 ALB 보안 그룹만 허용
```

이제 EC2는 ALB를 통해서만 접근 가능. 직접 접속 원천 차단.

### 4. SSL 인증서 발급 (ACM)

```
검증 방법: DNS 검증
Cloudflare에 CNAME 레코드 추가
5-10분 대기 → 발급 완료
```

**비용:** ACM은 **무료**임!

### 5. ALB HTTPS 리스너 추가

```
프로토콜: HTTPS
포트: 443
인증서: ACM 인증서
기본 작업: Target Group으로 전달
```

협력업체 도메인이 Cloudflare 프록시를 쓰고 있어서 HTTPS로만 연결됨.

### 6. DNS 설정

```
CNAME 레코드로 ALB DNS 연결
프록시 상태: DNS 전용 (회색 구름)
```

**왜 DNS 전용?**
- 프록시 활성화하면 Error 1014 발생
- 협력업체 측에서 이미 Cloudflare 프록시 사용 중
- 다층 보안 구조라 DNS만 해도 충분

## 트러블슈팅

### Issue 1: Target Group Unhealthy

**증상:** ALB가 계속 unhealthy 표시

**원인:** Health Check 경로(`/`)가 307 리다이렉트 응답

**해결:**
```bash
# EC2에서 테스트
curl -I http://localhost:3000/
# HTTP/1.1 307 Temporary Redirect ← 이게 문제

curl -I http://localhost:3000/api/health
# HTTP/1.1 200 OK ← 이걸로 변경
```

Health Check 경로를 `/api/health`로 변경하니까 바로 healthy 됨.

### Issue 2: HTTPS 접속 안 됨

**증상:** HTTP는 되는데 HTTPS는 "웹서버 다운"

**원인:** ALB에 HTTPS 리스너(443)가 없었음

**해결:** ACM 인증서 발급 → HTTPS 리스너 추가

### Issue 3: 브라우저에서 계속 다운으로 보임

**증상:** `curl`은 되는데 브라우저는 안 됨

**원인:** 브라우저 캐시

**해결:** `Cmd + Shift + R` (강력 새로고침) 또는 시크릿 모드

## 보안 검증

### EC2 IP 노출 확인

```bash
# DNS 조회
$ dig 협력업체도메인.co.kr +short
104.21.4.47
172.67.131.169
# ← Cloudflare IP만 보임 ✅

# IP 소유자 확인  
$ whois 104.21.4.47 | grep OrgName
OrgName: Cloudflare, Inc.
# ← EC2 IP 완전히 숨겨짐 ✅
```

완벽하게 숨겨짐!

## 비용

### ALB 비용
- 기본: $17.74/월 (시간당 $0.0243)
- LCU: $5-15/월 (트래픽에 따라)
- **총: 약 $25-35/월 (3-4만원)**

### ACM
- **무료** ✅

### 대안
- Nginx 프록시 (t4g.nano): $3/월
- CloudFront + Lambda@Edge
- 협력업체에 SSL Flexible 요청 (무료)

나는 보안이 중요해서 ALB 선택했지만, 비용이 부담된다면 Nginx 프록시도 괜찮은 선택.

## 최종 결과

### Before
```
whois로 검색 → EC2 IP 노출
서버 이전 시 → 모든 협력업체에 IP 변경 통보 필요
```

### After  
```
whois로 검색 → Cloudflare IP만 보임
서버 이전 시 → ALB만 변경, 협력업체는 신경 안 써도 됨
EC2는 Private 네트워크에서 안전하게 보호됨
```

## 배운 점

1. **다층 보안의 중요성**
   - 한 겹만 있으면 뚫리기 쉬움
   - Cloudflare + ALB + Private EC2 = 3중 방어

2. **Health Check는 생각보다 중요**
   - 200 OK 응답하는 엔드포인트 필수
   - 리다이렉트는 unhealthy 처리됨

3. **가용 영역 매칭**
   - ALB 가용 영역에 EC2 영역 반드시 포함
   - 안 그러면 타임아웃 지옥

4. **ACM은 혜자**
   - SSL 인증서 무료로 발급/갱신
   - 자동 갱신이라 관리 편함

5. **보안은 비용이다**
   - ALB 월 3-4만원
   - 하지만 해킹 당하는 것보다 싸다
