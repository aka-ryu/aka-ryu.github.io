---
layout: post
title: HANDSON - 많은 요청에 대한 병렬처리 경험
category: HANDSON
---
---

# 수천 개 외부 API 요청을 효율적으로 처리하는 병렬 아키텍처 설계

실무에서는 때때로 단일 요청으로 끝나지 않고, `N * M` 조합에 따라 **수천 건의 외부 API 호출이 필요한 상황**이 발생하곤 한다. 이 글은 그런 상황에서 **안정적으로, 빠르게, 효율적으로** 병렬 요청을 처리하는 패턴과 실무에서 직접 겪은 사례를 바탕으로 정리한 것이다.

---

## ✅ 실무에서 겪은 사례

* 해당 작업은 **하루에 1번 실행되는 배치 프로세스**였다.
* 실행 전, **금일 날짜 기준으로 작업 프로세스를 등록**하고 `status = PENDING` 상태로 설정하였다.
* 총 17개의 기준 데이터 × 각 기준별 352개의 하위 항목을 조회해야 했고, 결과적으로 총 **17 × 352 = 5,984건의 외부 API 요청**이 필요했다.
* 이 요청들을 **동기적으로 1개씩 처리하면 너무 오래 걸려**, **10개 단위로 나눠 병렬 비동기 요청을 처리**하였다.
* 특히 서버에 무리가 가지 않도록 **동시 요청 수를 제한(concurrency control)** 하여 처리하였다.
* 수집된 모든 데이터를 **1개의 트랜잭션으로 저장**하되, **요청 중 하나라도 실패하거나 중간 단계에서 오류가 발생하면 전체 프로세스를 종료**하고, 프로세스 상태를 `FAILED`로 저장하였다.
* 성공적으로 모든 데이터가 수집되고 저장된 경우에만 `status = SUCCESS`로 마무리되도록 설계하였다.
* 실패한 요청은 **에러 로그로 따로 저장하여 나중에 재시도할 수 있도록 처리**하였다.

이 과정에서 다음과 같은 아키텍처 요소들을 고려했다.

---

## ✅ 실무에서 고려해야 할 핵심 포인트

### 1. **병렬 개수 제한 (concurrency limit)**

* 과도한 병렬 요청은 네트워크/서버/외부 API 모두에 부하를 준다.
* 일반적으로 5\~20개의 범위로 제한하여 안정성을 확보한다.

### 2. **외부 API Rate Limit 고려**

* 초당/분당 제한이 있는 경우, 이를 넘으면 429 에러 발생
* 필요한 경우 요청 큐나 토큰 버킷 전략 도입 필요


### 3. **타임아웃 설정**

* 외부 API가 응답이 없을 때 프로그램이 멈추지 않도록 각 요청에 타임아웃을 설정해야 한다.

### 4. **실패 즉시 중단 (fail-fast)**

* 모든 요청 결과를 수집한 뒤 저장하는 것이 아니라, 요청 중 하나라도 실패하면 **즉시 전체 프로세스를 종료**하고, **프로세스 상태를 FAILED로 저장**하여 무결성을 보장하였다.
* 실패한 요청은 **에러 로그로 기록**하여 이후 재처리를 위한 기반으로 사용하였다.

### 5. **트랜잭션 단위 저장**

* 모든 요청이 성공적으로 끝난 뒤, 수집된 데이터를 **한 번에 하나의 트랜잭션으로 저장**하였다.
* 이로써 저장 중간에 실패가 발생할 경우에도 **무결성이 보장**되도록 했다.

### 6. **모니터링과 통계 수집**

* 전체 성공률, 평균 처리 시간, 에러 유형 등을 로깅하여 이후 대응 가능하게 해야 한다

---

---

## ✅ 결론

수천 건의 외부 API 요청을 처리하는 구조는 단순한 반복이 아니라, **시스템 안정성과 성능을 동시에 고려한 설계**가 필요하다.

* 병렬 수 제한 (Controlled Concurrency)
* 실패 즉시 중단 및 로그 기반 복구 전략
* 요청 성공 시 트랜잭션 단위로 데이터 일괄 저장
* 작업 시작과 종료 시점에 배치 상태 관리 (PENDING → SUCCESS/FAILED)
* 모니터링 및 로깅

이러한 요소들을 고려한 구조를 잘 짜두면, 예상치 못한 대량 트래픽에도 유연하게 대응할 수 있다.
