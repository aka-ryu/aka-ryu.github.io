---
layout: post
title: LIBRARY - 애플리케이션에 구글 어센시케이터 인증 구현
category: LIBRARY
---

Nextjs, NodeJs 를 이용하여하여 개발한 어플리케이션에 구글어센시 케이터 구현
<br><br>
필요 라이브러리 : speakeasy, qrcode

![scrennsh](/public/img/20240806/20240806_00.png)

generateSecret = 비밀키와 otpUrl생성  
issure, 와 accountName 은 구글어센시 케이터에 등록될 정보
<br><br>

사실 뭐 방법이야 많고 인터넷에 검색하면 다 나온다  
중요한 부분은 지금 내 어플리케이선의 유저,인증 관리 상태가 어떻게 되는지, 그에 맞춰서 어떤 방법을 적용시킬지가 선택하는게 문제인데
<br><br>

내 환경은 다음과 같았다.
<br><br>

BO페이지 이기 때문에 회원가입등의 경로 없이 초기 SEED 나 DB에 직접 쿼리를 날려서 계정을 생성한다.

즉 회원가입과 동시에 구글 어센시 케이터를 등록하는 방법은 불가능 하였다.  
<s>라고 작성하는 동시에 회원가입과 동시에 qrUrl을 이메일로 전송시키고 secret을 바로 저장하면 되는 방법이 생각났다..<br>
모든걸 개발단에서 풀려고 접근하는 선입견이슈...</s>
<br><br>

아무튼 바보같이 유저기준으로 개발단에서 설정하려는 방법으로는 다음과 같이 설계 후 개발하였다.  
two_fa 인증을 확인할 테이블을 새로 구성 및 two_fa 인증을 한 어드민은 해당 테이블에 two_fa 정보가 저장됨.
<br><br>

유저가 로그인하면 two_fa 테이블을 확인하여 아직 등록을 안한 유저에게는 secret과 qrUrl을 발급하여 리턴한다.  
프론트에서는 해당 qrUrl을 표현해주고 유저에게 qrCode를 등록 후 다음버튼을 누르도록 안내

![scrennsh](/public/img/20240806/20240806_01.png)  
<br><br>

이후 유저가 구글어센시케이터에서 6자리 숫자 인증코드를 입력하게 한다.  
![scrennsh](/public/img/20240806/20240806_02.png)
<br><br>

유저가 입력한 인증코드와 그전 요청에서 받은 secret을 백엔드로 전송한다.  
백엔드에서는 해당 인증코드와 secret을 검증 후 인증정보가 맞을 경우 two_fa 테이블에 유저와 릴레이션십을 걸고 저장한다.  
<s>적고보니... 차라리 시크릿,qr 전부 프론트에서 만들고 확인해서 마지막에 등록 secret만 백엔드로 보내는게 더 편했겠네...</s>
<br><br>

secret 키의 경우는 초기 등록할때 유저가 qrcode를 등록했는지 확인이 필요하기 때문에 한번만 계층간 전송을 하는것이고  
이미 등록한 유저의 경우에는 인증코드만 확인해서 백엔드에서 secret 키와 유효성 검사만 처리하면 된다.
