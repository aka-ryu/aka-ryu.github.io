---


layout: post
title: AWS - MongoDB 설치와 VPC 내 EC2 간 연결 플로우
categories: AWS
---

# AWS EC2에 MongoDB 설치 후 VPC 내 다른 EC2에서 연결하기

현재 관리하는 데이터의 생성방식과 사용방식이 기존 RDS DB 시스템보다 **NoSQL**이 더 적합하여,
MongoDB로 마이그레이션을 결정했다.

DB 자체 마이그레이션은 완료했지만, AWS DocumentDB로 배포하려니 **가격이 너무 비싸서**
직접 EC2에 MongoDB를 설치해 운영하기로 했다.

그 과정에서 MongoDB가 설치된 EC2(A)와, 해당 DB를 사용하는 EC2(B)가 **같은 VPC 다른 서브넷** 환경에서
서로 통신하도록 **보안그룹과 MongoDB 설정을 조정**한 내용을 정리한다.

---

## ✅ 환경

* **EC2 A**: MongoDB 설치됨, 데이터 보관용
* **EC2 B**: 애플리케이션 서버, A의 MongoDB 데이터를 사용
* 같은 VPC, 다른 서브넷
* 연결 방식: 프라이빗 IP (`172.31.x.xxx`)로 직접 통신

---

## 1. 보안그룹 설정

### A 인스턴스 보안그룹 (Inbound)

* **포트 27017** 허용
* 소스: **B 인스턴스의 보안그룹** (SG-ID로 지정)
  → IP 변경 시에도 계속 연결 가능

```
Type: Custom TCP
Port: 27017
Source: sg-xxxxxxxx (B 인스턴스의 SG)
```

### Outbound

* 기본 All Traffic 허용이면 추가 설정 불필요

---

## 2. MongoDB 설정 수정

처음 설치 후 `lsof -iTCP:27017 -sTCP:LISTEN`으로 확인해보니:

```
TCP localhost:27017 (LISTEN)
```

이렇게 `127.0.0.1`에만 바인딩되어 외부 접근이 불가능했다.

### `/etc/mongod.conf` 수정

```yaml
net:
  port: 27017
  bindIp: 127.0.0.1,172.31.x.xxx  # A 인스턴스의 프라이빗 IP
```


### 적용

```bash
sudo systemctl restart mongod
```

수정 후 다시 확인:

```
TCP 172.31.x.xxx:27017 (LISTEN)
```

---

## 3. OS 방화벽 확인

### UFW 사용 시

```bash
sudo ufw allow 27017/tcp
sudo ufw status
```

### firewalld 사용 시

```bash
sudo firewall-cmd --add-port=27017/tcp --permanent
sudo firewall-cmd --reload
```

---

## 4. 연결 테스트

### B에서 포트 연결 확인

```bash
nc -zv 172.31.x.xxx 27017
```

성공 시:

```
Connection to 172.31.x.xxx 27017 port [tcp/*] succeeded!
```

### MongoDB 직접 접속

```bash
mongosh --host 172.31.x.xxx --port 27017 --eval "db.runCommand({ping:1})"
```

결과:

```
{ ok: 1 }
```

---

## 5. 문제 해결 과정 요약

* **Ping 안 됨** → 같은 VPC, 다른 서브넷이라도 ICMP 차단 가능 → SG에 All ICMP 추가로 해결
* **27017 Connection refused** → mongod가 localhost만 바인딩 → bindIp 수정 후 재시작
* **SG, NACL, OS 방화벽** 순서대로 점검
* **SG는 IP 대신 보안그룹 참조**로 설정 → IP 변경 시에도 문제 없이 연결 유지

---

## 🧠 정리

1. 같은 VPC라도 보안그룹에서 포트 허용이 필요하다.
2. MongoDB는 설치 직후 `127.0.0.1`만 바인딩되어 있으니, **프라이빗 IP 또는 0.0.0.0**으로 수정해야 한다.
3. SG는 가능하면 **IP가 아니라 보안그룹 ID**를 소스로 지정한다.
4. 연결 불가 시, **SG → NACL → OS 방화벽 → mongod.conf** 순서로 점검하면 원인을 빨리 찾을 수 있다.

이 과정을 거치면 DocumentDB 대신 **저렴한 EC2 + MongoDB 조합**으로 VPC 내부 안전한 연결 구성이 가능하다.
